<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>ECE AST - Transpilers</title>

    <meta name="description" content="ECE NodeJS class on Transpilers">
    <meta name="author" content="Pierre Berezowski">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="../reveal.js/css/reveal.css">
    <link rel="stylesheet" href="../reveal.js/css/theme/black.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="../reveal.js/lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? '../reveal.js/css/print/pdf.css' : '../reveal.js/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div style="position:absolute; top:20px; left:20px;">
    <p><img src="../img/adaltas.png" width="200px" style="margin: 10px 0" /></p>
    </div>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <h1>Storage</h1>
          <h4>Asynchronous Server Technologies</h4>
          <p>
            Sergei Kudinov<br/>
            <i>Web Developer @ Adaltas</i><br/>
            <i>sergei@adaltas.com</i>
          </p>
        </section>

        <section data-markdown>
          ## About this course

          * You will use / do :
            * JavaScript / TypeScript & Markdown
            * Node.JS & NPM or yarn
            * Git & Github / GitLab
            * Unit tests & Travis CI
            * Use a framework & transpiler
            * Use MongoDB
            * Read the doc ! Ask Google !
          * You will apprehend tools of the Open Source
        </section>

        <section data-markdown>
          ## About this course

          * Evaluation :
            * Continuous using Git
            * Simple project at the end of the course
          * Planning: [CALENDAR.md](https://github.com/adaltas/ece-nodejs/blob/2019/CALENDAR.md)
        </section>

        <section data-markdown>
          ## Final project

          * Based on code from class
          * Using presented technologies
          * Simple dashboard app :
            * User login
            * A user can insert simple metrics
            * A user can retrieve his metrics displayed nicely in a graph
            * A user can only access his own metrics
          * See [PROJECT.md](https://github.com/adaltas/ece-nodejs/blob/2019/PROJECT.md)
        </section>

        <section data-markdown>
          ## Questions ?
        </section>
      
        <section data-markdown>
          ## Summary 
          
          * Storage
          * NoSQL
          * MongoDB
        </section>

        <section data-markdown>
          ## What about storage ?
        </section>

        <section data-markdown>
          ## Databases

          * RDBMS -> MySQL, PostGreSQL, Hive
          * NoSQL
            * Column families: HBase, Cassandra
            * Document Store: MongoDB, ElasticSearch
            * Key Value: LevelDB
            * Graph DBs: JanusGraph (ex-TitanDB), Neo4J
        </section>

        <section data-markdown>
          ## MongoDB

          * NoSQL DB, Document Store
          * Stores data in flexible, JSON-like documents
          * Distributed database
          * [mongodb.com](http://mongodb.com)
        </section>
        
        <section data-markdown>
          ## JSON Documents

          * As a programmer, you think in objects
          * Supports arrays and nested objects as values
          * Allows for flexible and dynamic schemas
        </section>

        <section data-markdown>
          ## Query language

          * Filter and sort by any field
          * No matter how nested it may be within a document
          * Queries are themselves JSON
        </section>

        <section data-markdown>
          ## Why we use MongoDB?

          * Easy: work with data in a intuitive way
          * Fast: great performance
          * Flexible: adapt and make changes quickly
          * Versatile: wide variety of data and queries
        </section>
        
        <section data-markdown>
          ## Let’s setup
          
          * Dependencies install
          ```shell
          npm install mongodb --save
          npm install --save @types/express express body-parser nodemon
          ```
          * Create a database directory `/data` (in the root directory)
          * Install and start a mongod process:
          ```shell
          mongod --dbpath=/data
          ```
        </section>

        <section data-markdown>
          ## Let’s setup
          
          * In the `src/mongodb-test.ts` file: 
          
          ```javascript
          import mongodb from 'mongodb'
          const MongoClient = mongodb.MongoClient
          // Connection URL
          const url: string = 'mongodb://localhost:27017';
          // Database Name
          const dbName: string = 'mydb';
          ```
        </section>

        <section data-markdown>
          ## Let’s setup

          * Create connection and a data base. In the `src/mongodb-test.ts` file: 

          ```javascript
          // Create a new MongoClient
          const client = new MongoClient(url, { useNewUrlParser: true });
          // Use connect method to connect to the Server
          client.connect(function(err) {
            if(err){
              throw err
            }
            console.log("Connected successfully to server");
            const db = client.db(dbName);
            // Do something ...
            client.close();
          });
          ```
        </section>

        <section data-markdown>
          ## Let’s setup

          * Check out your app. Run:
          ```shell
          ts-node ./src/mongodb-test
          ```
          
          * Check with Robo 3T
        </section>
        
        <section data-markdown>
          ## Write metrics 
          
          * Create interface for metrics. In the `src/mongodb-test.ts` file:
          
          ```javascript
          interface Metric {
            timestamp: string;
            value: number;
          }
          ```
        </section>
                
        <section data-markdown>
          ## Write metrics 
          
          * Insert document. In the `src/mongodb-test.ts` file:
          
          ```javascript
          const insertDocument = function(db: any, callback: any) {
            // Get the documents collection
            const collection = db.collection('documents');
            // Insert some document
            const metric: Metric = {
              timestamp: new Date().getTime().toString(),
               value: 42
             }
            collection.insertOne(
              metric,
              function(err: any, result: any) {
                if(err)
                  throw err
                console.log("Document inserted into the collection");
                callback(result);
            });
          }
          ```
          
          * Call the function:
          ```javascript
          insertDocument(db, function() {
            client.close();
          });
          ```
        </section>
                
        <section data-markdown>
          ## Write metrics 
          
          * One by one ? Too heavy! Use `insertMany()`:
          
          ```javascript
          const insertManyDocuments = function(db: any, callback: any) {
            // Get the documents collection
            const collection = db.collection('documents');
            // Insert some documents
            const metrics: Metric[] = [
              { timestamp: new Date().getTime().toString(), value: 11},
              { timestamp: new Date().getTime().toString(), value: 22},
              { timestamp: new Date().getTime().toString(), value: 22},
            ]
            collection.insertMany(
              metrics,
              function(err: any, result: any) {
                if(err)
                  throw err
                console.log("Document inserted into the collection");
                callback(result);
            });
          }
          ```
        </section>

        <section data-markdown>
          ## Read metrics 
          
          * Find all documents
          
          ```javascript
          const findDocuments = function(db: any, callback: any) {
            // Get the documents collection
            const collection = db.collection('documents');
            // Find some documents
            collection.find({}).toArray(function(err: any, docs: object) {
              if(err)
                throw err
              console.log("Found the following documents");
              console.log(docs)
              callback(docs);
            });
          }
          ```
          
          * Call the function:
          
          ```javascript
          insertDocument(db, function() {
            findDocuments(db, function() {
              client.close();
            });
          });
          ```
        </section>

        <section data-markdown>
          ## Read specific metrics 
          
          * Find documents with a query filter
          
          ```javascript
          const findDocuments = function(db: any, callback: any) {
            // Get the documents collection
            const collection = db.collection('documents');
            // Find some documents
            collection.find({'value': 42}).toArray(function(err: any, docs: object) {
              if(err)
                throw err
              console.log("Found the following documents");
              console.log(docs)
              callback(docs);
            });
          }
          ```
        </section>
        
        <section data-markdown>
          ## Let’s now initialize a connection

          * In `src/server.ts`:
          
          ```javascript 
          // Initialize connection once
          var db: any
          import mongodb from 'mongodb'
          const MongoClient = mongodb.MongoClient // Create a new MongoClient
          MongoClient.connect("mongodb://localhost:27017", { useNewUrlParser: true }, (err: any, client: any) => {
            if(err) throw err
            db = client.db('mydb')
            
            // Start the application after the database connection is ready
            const port: string = process.env.PORT || '8115'
            app.listen(port, (err: Error) => {
              if (err) {
                throw err
              }
              console.log(`server is listening on port ${port}`)
            })
          });
          ```
        </section>

        <section data-markdown>
          ## Let’s post some metrics

          In `src/metrics.ts`
          
          * Update the class to open a database connection 
          
          ```javascript
          
          export class MetricsHandler {
            private clientStart: any
            
            constructor(db) { 
              this.clientStart = clientStart
            }
          }
          ```
        </section>
        
        <section data-markdown>
          ## Let’s post some metrics

          In `src/metrics.ts`
          
          * Add a function to save data
          
          ```javascript
          export class MetricsHandler {
            public save(metric: Metric, callback: (err: Error | null, result?: any) => void) {
              const collection = this.db.collection('documents')
              // Insert some document
              collection.insertOne(
                metric,
                function(err: any, result: any) {
                  if(err)
                    return callback(err, result)
                  console.log("Document inserted into the collection")
                  callback(err, result)
              });
            }
          }
          ```
        </section>

        <section data-markdown>
          ## Let’s post some metrics

          Install body-parser to parse the request’s body

          ```shell
          npm i --save body-parser
          ```

          Configure Express to use it in `src/server.ts`

          ```javascript
          app.use(bodyparser.json())
          app.use(bodyparser.urlencoded({extended: true}))
          ```
        </section>

        <section data-markdown>
          ## Let’s post some metrics

          * Add post route:
          
          ```javascript
          app.post('/metrics', (req: any, res: any) => {
            if(req.body){
              const metric = new Metric(parseInt(req.body.value));
              new MetricsHandler(db).save(metric, (err: any, result: any) => {
                if (err)
                  return res.status(500).json({error: err, result: result});
                res.status(201).json({error: err, result: true})
              })
            }else{
              return res.status(400).json({error: 'Wrong request parameter',});
            }
          })
          ```
        </section>

        <section data-markdown>
          ## Let’s post some metrics

          * Using Postman :
            * Set up a POST request on /metrics
            * Set the header Content-Type:application/json
            * Add an array of metrics as RAW body :

          ```shell
          {"value":"10"}
          ```
        </section>

        <section data-markdown>
          ## Or use a script ?
          
          Create file ./bin/populate.ts:
          ```javascript
          import { Metric, MetricsHandler } from '../src/metrics'
          var metrics = [new Metric(11), new Metric(12), new Metric(13), new Metric(14)]

          import mongodb from 'mongodb'
          const MongoClient = mongodb.MongoClient
          MongoClient.connect("mongodb://localhost:27017", { useNewUrlParser: true }, (err: any, client: any) => {
            if(err) throw err
            const db = client.db('mydb')
            metrics.map(metric => {
              new MetricsHandler(db).save(metric, (err: any, result: any) => {
                if (err) console.log(err)
              })
            })
            client.close()
          });
          ```
          
          Run:
          ```shell
          ts-node ./bin/populate
          ```
        </section>

        <section data-markdown>
          ## Questions ?
        </section>

        <section data-markdown>
          ## Your work

          * Add a `get` function to `metrics` module
          * Add a route to get a metric (one of the metric, all the metrics)
          * Add a `delete` function to `metrics` module
          * Add a route to delete a metric based on its `value`
        </section>
      </div>
    </div>

    <script src="../reveal.js/lib/js/head.min.js"></script>
    <script src="../reveal.js/js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: '../reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: '../reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '../reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '../reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: '../reveal.js/plugin/zoom-js/zoom.js', async: true },
          { src: '../reveal.js/plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
